// wui.cpp : Defines the entry point for the application.
//

#include <wui/theme/theme.hpp>
#include <wui/window/window.hpp>
#include <wui/control/button.hpp>
#include <wui/control/input.hpp>
#include <wui/control/image.hpp>

#ifdef _WIN32
#include <Resource.h>
#include <gdiplus.h>
#endif

#ifdef _WIN32
static const char *dark_json = "{ \"controls\": [ { \"type\": \"window\", \"background\": \"#131519\", \"text\": \"#f5f5f0\", \"active_button\": \"#3b3d41\", \"caption_font\": { \"name\": \"Segoe UI\", \"size\": 18 } }, { \"type\": \"image\", \"path\": \"IMAGES_DARK\" }, { \"type\": \"button\", \"calm\": \"#06a5df\", \"active\": \"#1aafe9\", \"border\": \"##00a0d2\", \"focused_border\": \"#dcd2dc\", \"text\": \"#f0f1f1\", \"disabled\": \"#a5a5a0\", \"round\": 0, \"font\": { \"name\": \"Segoe UI\", \"size\": 18 } }, { \"type\": \"input\", \"background\": \"#27292d\", \"text\": \"#f0ebf0\", \"selection\": \"#264f78\", \"cursor\": \"#d2d2d2\", \"border\": \"#8c8c8c\", \"focused_border\": \"#c8c8c8\", \"round\": 0, \"font\": { \"name\": \"Segoe UI\", \"size\": 18 } }, { \"type\": \"tooltip\", \"background\": \"#b4aabe\", \"border\": \"#f1f2f7\", \"text\": \"#061912\", \"round\": 0, \"text_indent\": 3, \"font\": { \"name\": \"Segoe UI\", \"size\": 16 } } ], \"images\": [ { \"window_close\": \"0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0x19, 0x08, 0x06, 0x00, 0x00, 0x00, 0xC4, 0xE9, 0x85, 0x63, 0x00, 0x00, 0x00, 0x09, 0x70, 0x48, 0x59, 0x73, 0x00, 0x00, 0x0B, 0x13, 0x00, 0x00, 0x0B, 0x13, 0x01, 0x00, 0x9A, 0x9C, 0x18, 0x00, 0x00, 0x00, 0x19, 0x74, 0x45, 0x58, 0x74, 0x53, 0x6F, 0x66, 0x74, 0x77, 0x61, 0x72, 0x65, 0x00, 0x41, 0x64, 0x6F, 0x62, 0x65, 0x20, 0x49, 0x6D, 0x61, 0x67, 0x65, 0x52, 0x65, 0x61, 0x64, 0x79, 0x71, 0xC9, 0x65, 0x3C, 0x00, 0x00, 0x00, 0xD8, 0x49, 0x44, 0x41, 0x54, 0x78, 0xDA, 0x62, 0xFC, 0xFF, 0xFF, 0x3F, 0x03, 0xAD, 0x01, 0x13, 0x03, 0x1D, 0xC0, 0xA8, 0x25, 0xA3, 0x96, 0x60, 0x82, 0x0B, 0x97, 0xCE, 0x2D, 0x00, 0xE2, 0x49, 0x04, 0xD4, 0xD8, 0x02, 0xF1, 0x11, 0x4A, 0x7C, 0x72, 0x11, 0x88, 0x73, 0x81, 0x86, 0xCC, 0xC1, 0x65, 0x01, 0x90, 0xDA, 0x06, 0xC4, 0xDF, 0xC8, 0xB6, 0xC4, 0x40, 0xCF, 0xA8, 0x1F, 0x48, 0xD5, 0x03, 0x71, 0x32, 0xBA, 0x45, 0x48, 0x16, 0x1C, 0x07, 0xAA, 0x73, 0xA3, 0x28, 0x4E, 0x80, 0x06, 0x34, 0xA1, 0x5B, 0x04, 0xB5, 0x60, 0x27, 0x31, 0x16, 0x80, 0x00, 0x23, 0xB1, 0xC5, 0x0A, 0xD0, 0xE0, 0x3A, 0x20, 0xD5, 0x08, 0x35, 0xDC, 0x05, 0x88, 0x4F, 0x00, 0x2D, 0xB0, 0x21, 0x46, 0x2F, 0x23, 0x29, 0x65, 0x17, 0xD0, 0xA2, 0x15, 0x40, 0x2A, 0x1C, 0x88, 0x1F, 0x02, 0x2D, 0x50, 0xA0, 0x7A, 0x12, 0x06, 0x5A, 0x00, 0x32, 0x3C, 0x0C, 0x64, 0x01, 0x10, 0xCB, 0x43, 0x7D, 0x46, 0x3D, 0x4B, 0xA0, 0x16, 0x2C, 0x07, 0xE2, 0x63, 0x50, 0x1F, 0x80, 0xE2, 0xA8, 0x96, 0x68, 0x8B, 0x40, 0xC1, 0x85, 0x0F, 0x9F, 0xBF, 0x78, 0x36, 0x1C, 0x88, 0xFF, 0x01, 0xF1, 0x11, 0x34, 0xF1, 0x3A, 0x20, 0xFE, 0x0E, 0xA2, 0x09, 0x99, 0x41, 0x96, 0x05, 0xA4, 0x5A, 0x44, 0x28, 0xB8, 0xCA, 0x81, 0x78, 0x0F, 0xAE, 0x54, 0x04, 0x4D, 0xDE, 0xED, 0xA0, 0x0C, 0x4B, 0xB5, 0xD4, 0x35, 0x5A, 0x0A, 0x8F, 0x5A, 0x32, 0xF8, 0x2C, 0x01, 0x08, 0x30, 0x00, 0x7F, 0xB2, 0xEA, 0x65, 0x17, 0xA5, 0x1F, 0x81, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82\" }, { \"window_expand\": \"0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0x19, 0x08, 0x06, 0x00, 0x00, 0x00, 0xC4, 0xE9, 0x85, 0x63, 0x00, 0x00, 0x00, 0x09, 0x70, 0x48, 0x59, 0x73, 0x00, 0x00, 0x0B, 0x13, 0x00, 0x00, 0x0B, 0x13, 0x01, 0x00, 0x9A, 0x9C, 0x18, 0x00, 0x00, 0x00, 0x19, 0x74, 0x45, 0x58, 0x74, 0x53, 0x6F, 0x66, 0x74, 0x77, 0x61, 0x72, 0x65, 0x00, 0x41, 0x64, 0x6F, 0x62, 0x65, 0x20, 0x49, 0x6D, 0x61, 0x67, 0x65, 0x52, 0x65, 0x61, 0x64, 0x79, 0x71, 0xC9, 0x65, 0x3C, 0x00, 0x00, 0x00, 0x64, 0x49, 0x44, 0x41, 0x54, 0x78, 0xDA, 0x62, 0xFC, 0xFF, 0xFF, 0x3F, 0x03, 0xAD, 0x01, 0x13, 0x03, 0x1D, 0xC0, 0xA8, 0x25, 0x23, 0xD4, 0x12, 0x16, 0x6C, 0x82, 0x17, 0x2E, 0x9D, 0x9B, 0x00, 0xA4, 0x0C, 0x48, 0x35, 0xCC, 0x40, 0xCF, 0xC8, 0x81, 0x14, 0x9F, 0x18, 0x90, 0x68, 0x89, 0x02, 0x10, 0xDB, 0x93, 0xE4, 0x13, 0x98, 0x87, 0x70, 0xB9, 0x0C, 0x8B, 0xCF, 0x1B, 0x80, 0x54, 0xFD, 0x68, 0xEA, 0x1A, 0xB5, 0x64, 0x90, 0x64, 0x46, 0x58, 0xDA, 0x87, 0x26, 0x4D, 0x62, 0x80, 0x03, 0xB9, 0x96, 0xC8, 0xE3, 0x4B, 0xFB, 0xA4, 0x00, 0xC6, 0xD1, 0x9A, 0x71, 0xD4, 0x92, 0xA1, 0x6D, 0x09, 0x40, 0x80, 0x01, 0x00, 0x94, 0xC7, 0x13, 0xEF, 0xA5, 0x34, 0x2A, 0xAF, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82\" }, { \"window_normal\": \"0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0x19, 0x08, 0x06, 0x00, 0x00, 0x00, 0xC4, 0xE9, 0x85, 0x63, 0x00, 0x00, 0x00, 0x09, 0x70, 0x48, 0x59, 0x73, 0x00, 0x00, 0x0B, 0x13, 0x00, 0x00, 0x0B, 0x13, 0x01, 0x00, 0x9A, 0x9C, 0x18, 0x00, 0x00, 0x00, 0x19, 0x74, 0x45, 0x58, 0x74, 0x53, 0x6F, 0x66, 0x74, 0x77, 0x61, 0x72, 0x65, 0x00, 0x41, 0x64, 0x6F, 0x62, 0x65, 0x20, 0x49, 0x6D, 0x61, 0x67, 0x65, 0x52, 0x65, 0x61, 0x64, 0x79, 0x71, 0xC9, 0x65, 0x3C, 0x00, 0x00, 0x00, 0xA2, 0x49, 0x44, 0x41, 0x54, 0x78, 0xDA, 0x62, 0xFC, 0xFF, 0xFF, 0x3F, 0x03, 0xAD, 0x01, 0x13, 0x03, 0x1D, 0xC0, 0xA8, 0x25, 0x83, 0xCF, 0x12, 0x16, 0x62, 0x15, 0x5E, 0xB8, 0x74, 0xEE, 0x00, 0x31, 0xCA, 0x0C, 0xF4, 0x8C, 0x0A, 0xC8, 0xB6, 0x04, 0x08, 0xEC, 0x81, 0xF8, 0x21, 0x10, 0x3F, 0xC0, 0x21, 0x6F, 0x40, 0xB1, 0x4F, 0xA0, 0x60, 0x01, 0xD0, 0xA5, 0x0D, 0xA4, 0xFA, 0x74, 0xE0, 0xE2, 0x04, 0xE8, 0x2A, 0x05, 0x20, 0xA5, 0x80, 0x45, 0x4A, 0x01, 0x28, 0xE7, 0x80, 0x16, 0x07, 0x1F, 0xC8, 0x8D, 0xF8, 0x04, 0x20, 0xAE, 0xC7, 0x22, 0x1E, 0x0F, 0xC5, 0x30, 0xE0, 0x08, 0xC4, 0x07, 0x28, 0x4D, 0x5D, 0x8E, 0x78, 0x22, 0xB9, 0x1F, 0xE4, 0x18, 0x24, 0x9F, 0x29, 0xE0, 0x4A, 0x14, 0x78, 0x2D, 0x01, 0x06, 0xC5, 0x01, 0x1C, 0xC1, 0x89, 0xEC, 0x33, 0x64, 0xF0, 0x80, 0x1A, 0xA9, 0x0B, 0xC3, 0xA7, 0xB8, 0x1C, 0x32, 0x02, 0x8B, 0x15, 0x60, 0xD8, 0xFF, 0xA7, 0xA5, 0x25, 0x07, 0x88, 0xD4, 0xFF, 0x80, 0x18, 0x45, 0x8C, 0xA3, 0xD5, 0xEF, 0xA8, 0x25, 0x34, 0x03, 0x00, 0x01, 0x06, 0x00, 0xF9, 0x97, 0x2D, 0x6C, 0x84, 0xE4, 0x6F, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82\" }, { \"window_minimize\": \"0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x18, 0x08, 0x06, 0x00, 0x00, 0x00, 0xE0, 0x77, 0x3D, 0xF8, 0x00, 0x00, 0x00, 0x19, 0x74, 0x45, 0x58, 0x74, 0x53, 0x6F, 0x66, 0x74, 0x77, 0x61, 0x72, 0x65, 0x00, 0x41, 0x64, 0x6F, 0x62, 0x65, 0x20, 0x49, 0x6D, 0x61, 0x67, 0x65, 0x52, 0x65, 0x61, 0x64, 0x79, 0x71, 0xC9, 0x65, 0x3C, 0x00, 0x00, 0x00, 0x37, 0x49, 0x44, 0x41, 0x54, 0x78, 0xDA, 0x62, 0x62, 0xA0, 0x31, 0x60, 0x1A, 0xB5, 0x60, 0xD4, 0x82, 0x51, 0x0B, 0x46, 0x2D, 0x18, 0xB5, 0x60, 0x28, 0x58, 0xC0, 0x82, 0x4F, 0xF2, 0xFC, 0xC5, 0xB3, 0xFB, 0x49, 0x30, 0xAB, 0xD0, 0x50, 0xDF, 0xF8, 0x02, 0xDD, 0x7D, 0xC0, 0x30, 0x1A, 0xC9, 0xA3, 0x16, 0x50, 0x0C, 0x00, 0x02, 0x0C, 0x00, 0x26, 0xD9, 0x05, 0x31, 0x5A, 0x7B, 0xB2, 0x85, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82\" } ] }";
static const char *white_json = "{ \"controls\": [ { \"type\": \"window\", \"background\": \"#f0f0f0\", \"text\": \"#191914\", \"active_button\": \"#dcdcdc\", \"font\": { \"name\": \"Segoe UI\", \"size\": 18 } }, { \"type\": \"image\", \"path\" : \"IMAGES_WHITE\" }, { \"type\": \"button\", \"calm\": \"#06a5df\", \"active\": \"#1aafe9\", \"border\": \"#b0b0b0\", \"focused_border\": \"#140a14\", \"text\": \"#181818\", \"disabled\": \"#cdcdc8\", \"round\": 0, \"font\": { \"name\": \"Segoe UI\", \"size\": 18 } }, { \"type\": \"input\", \"background\": \"#dcdcdc\", \"text\": \"#191914\", \"selection\": \"#99c9ef\", \"cursor\": \"#141414\", \"border\": \"#28788c\", \"focused_border\": \"#140a14\", \"round\": 0, \"font\": { \"name\": \"Segoe UI\", \"size\": 18 } }, { \"type\": \"tooltip\", \"background\": \"#f1f2f7\", \"border\": \"#767676\", \"text\": \"#061912\", \"round\": 0, \"text_indent\": 3, \"font\": { \"name\": \"Segoe UI\", \"size\": 16 } } ] } ";
#elif __linux__
static const char *dark_json = "{ \"controls\": [ { \"type\": \"window\", \"background\": \"#131519\", \"text\": \"#f5f5f0\", \"active_button\": \"#3b3d41\", \"caption_font\": { \"name\": \"sans\", \"size\": 13 } }, { \"type\": \"image\", \"path\" : \"IMAGES_DARK\" }, { \"type\": \"button\", \"calm\": \"#06a5df\", \"active\": \"#1aafe9\", \"border\": \"#6b6b6b\", \"focused_border\": \"#dcd2dc\", \"text\": \"#f0f1f1\", \"disabled\": \"#a5a5a0\", \"round\": 0, \"font\": { \"name\": \"sans\", \"size\": 13 } }, { \"type\": \"input\", \"background\": \"#27292d\", \"text\": \"#f0ebf0\", \"selection\": \"#264f78\", \"cursor\": \"#d2d2d2\", \"border\": \"#8c8c8c\", \"focused_border\": \"#c8c8c8\", \"round\": 0, \"font\": { \"name\": \"sans\", \"size\": 13 } }, { \"type\": \"tooltip\", \"background\": \"#b4aabe\", \"border\": \"#f1f2f7\", \"text\": \"#061912\", \"round\": 0, \"text_indent\": 3, \"font\": { \"name\": \"sans\", \"size\": 12 } } ] } ";
static const char *white_json = "{ \"controls\": [ { \"type\": \"window\", \"background\": \"#f0f0f0\", \"text\": \"#191914\", \"active_button\": \"#dcdcdc\", \"font\": { \"name\": \"sans\", \"size\": 13 } }, { \"type\": \"image\", \"path\" : \"IMAGES_WHITE\" }, { \"type\": \"button\", \"calm\": \"#06a5df\", \"active\": \"#1aafe9\", \"border\": \"#b0b0b0\", \"focused_border\": \"#140a14\", \"text\": \"#181818\", \"disabled\": \"#cdcdc8\", \"round\": 0, \"font\": { \"name\": \"sans\", \"size\": 13 } }, { \"type\": \"input\", \"background\": \"#dcdcdc\", \"text\": \"#191914\", \"selection\": \"#99c9ef\", \"cursor\": \"#141414\", \"border\": \"#28788c\", \"focused_border\": \"#140a14\", \"round\": 0, \"font\": { \"name\": \"sans\", \"size\": 13 } }, { \"type\": \"tooltip\", \"background\": \"#f1f2f7\", \"border\": \"#767676\", \"text\": \"#061912\", \"round\": 0, \"text_indent\": 3, \"font\": { \"name\": \"sans\", \"size\": 12 } } ] } ";
#endif

struct PluggedWindow : public std::enable_shared_from_this<PluggedWindow>
{
    std::weak_ptr<wui::window> parentWindow;

    std::shared_ptr<wui::window> window;
    std::shared_ptr<wui::button> plugButton, unplugButton;

    std::weak_ptr<wui::button> createPluggedButton;

    bool plugged;

    void Plug()
    {
        if (parentWindow.lock())
            parentWindow.lock()->add_control(window, wui::rect{ 20, 30, 190, 190 });

        plugButton->disable();
        unplugButton->enable();

        plugged = !plugged;
    }

    void Unplug()
    {
        if (parentWindow.lock())
            parentWindow.lock()->remove_control(window);
        Init();
		
        plugButton->enable();
        unplugButton->disable();

        plugged = !plugged;
    }

    void SetPluggedButton(std::shared_ptr<wui::button> &createPluggedButton_)
    {
        createPluggedButton = createPluggedButton_;
    }

    void Init()
    {
        window->init("Child window plugged!", wui::rect{ 20, 30, 190, 190 }, wui::window_style::pinned, [this]() {
            if (createPluggedButton.lock())
                createPluggedButton.lock()->enable();
        });
    }

    PluggedWindow(std::shared_ptr<wui::window> &parentWindow_)
        : parentWindow(parentWindow_),
        window(new wui::window()),
        plugButton(new wui::button("Plug Window", std::bind(&PluggedWindow::Plug, this))),
        unplugButton(new wui::button("Unplug Window", std::bind(&PluggedWindow::Unplug, this))),
        createPluggedButton(),
        plugged(true)
    {
        window->add_control(unplugButton, wui::rect{ 10, 40, 110, 65 });
        window->add_control(plugButton, wui::rect{ 10, 85, 110, 110 });

        window->set_pin_callback([this](std::string &tooltip_text) {
            if (plugged)
            {
                Unplug();
                tooltip_text = "Pin the window";
            }
            else
            {
                Plug();
                tooltip_text = "Unpin the window";
            }
        });

        plugButton->disable();

        if (parentWindow.lock())
            parentWindow.lock()->add_control(window, wui::rect{ 20, 30, 190, 190 });

        Init();
    }
};

std::shared_ptr<wui::i_theme> MakeRedButtonTheme()
{
    auto redButtonTheme = wui::make_custom_theme();

    redButtonTheme->load_theme(*wui::get_default_theme());

    redButtonTheme->set_color(wui::button::tc, wui::button::tv_calm, wui::make_color(205, 15, 20));
    redButtonTheme->set_color(wui::button::tc, wui::button::tv_active, wui::make_color(235, 15, 20));
    redButtonTheme->set_color(wui::button::tc, wui::button::tv_border, wui::make_color(200, 215, 200));
    redButtonTheme->set_color(wui::button::tc, wui::button::tv_focused_border, wui::make_color(20, 215, 20));
    redButtonTheme->set_color(wui::button::tc, wui::button::tv_text, wui::make_color(190, 205, 190));
    redButtonTheme->set_color(wui::button::tc, wui::button::tv_disabled, wui::make_color(180, 190, 180));
    redButtonTheme->set_string(wui::image::tc, wui::image::tv_path, "IMAGES_DARK");
    
    return redButtonTheme;
}

#ifdef _WIN32
int APIENTRY wWinMain(_In_ HINSTANCE hInstance,
    _In_opt_ HINSTANCE hPrevInstance,
    _In_ LPWSTR    lpCmdLine,
    _In_ int       nCmdShow)
{
    UNREFERENCED_PARAMETER(hPrevInstance);
    UNREFERENCED_PARAMETER(lpCmdLine);

    Gdiplus::GdiplusStartupInput gdiplusStartupInput;
    ULONG_PTR gdiplusToken;
    Gdiplus::GdiplusStartup(&gdiplusToken, &gdiplusStartupInput, NULL);
#elif __linux__
int main(int argc, char *argv[])
{
    const std::string IDB_ACCOUNT = "";

    if (setlocale(LC_ALL,"") == NULL)
    {
        fprintf(stderr, "warning: could not set default locale\n");
    }

#endif
    bool runned = true;

    wui::set_default_theme_from_json("dark", dark_json, true);

    std::shared_ptr<wui::window> window(new wui::window());

    std::shared_ptr<wui::image> accountImage(new wui::image(IDB_ACCOUNT));
    window->add_control(accountImage, wui::rect{ 250, 100, 314, 164 });

    std::shared_ptr<PluggedWindow> pluggedWindow(new PluggedWindow(window));
    std::shared_ptr<wui::button> createPluggedButton(new wui::button("Create plugged window", []() {}));
    createPluggedButton->set_callback([&window, &pluggedWindow, &createPluggedButton]() {
        pluggedWindow.reset();
        pluggedWindow = std::shared_ptr<PluggedWindow>(new PluggedWindow(window));
        pluggedWindow->SetPluggedButton(createPluggedButton);
        createPluggedButton->disable(); });
    createPluggedButton->disable();
    pluggedWindow->SetPluggedButton(createPluggedButton);

    window->add_control(createPluggedButton, wui::rect{ 270, 50, 380, 75 });
    
    std::shared_ptr<wui::input> nameInput(new wui::input());
    //nameInput->set_text(L"Hello world!");
    window->add_control(nameInput, wui::rect{ 10, 250, 400, 275 });

    std::shared_ptr<wui::window> dialog(new wui::window());

    std::shared_ptr<wui::button> okButton(new wui::button("OK", [window, &dialog]()
    {
        window->block();

        std::shared_ptr<wui::button> dialogButton(new wui::button("Close", [&dialog]() { dialog->destroy(); }));
        dialog->add_control(dialogButton, wui::rect{ 10, 200, 100, 235 });

        dialog->init("Modal dialog", wui::rect{ 50, 50, 350, 350 }, wui::window_style::dialog, [window, &dialog]() { window->unlock(); /*dialog.reset();*/ });
    }));

    std::shared_ptr<wui::button> cancelButton(new wui::button("Cancel", [window]() { window->destroy(); }, wui::button_view::only_image, IDB_ACCOUNT, 24, MakeRedButtonTheme()));

    std::shared_ptr<wui::button> darkThemeButton(new wui::button("Set the dark theme", [&window, &pluggedWindow, &dialog, &cancelButton]()
    {
        wui::set_default_theme_from_json("dark", dark_json, true);
        window->update_theme();
        pluggedWindow->window->update_theme();
        dialog->update_theme(); 
        cancelButton->update_theme(MakeRedButtonTheme());
    }));
    window->add_control(darkThemeButton, wui::rect{ 140, 350, 260, 375 });
	
    std::shared_ptr<wui::button> whiteThemeButton(new wui::button("Set the white theme", [&window, &pluggedWindow, &dialog, &cancelButton]()
    {
        wui::set_default_theme_from_json("white", white_json, false);
        window->update_theme();
        pluggedWindow->window->update_theme();
        dialog->update_theme();
        cancelButton->update_theme(MakeRedButtonTheme());
    }));
    window->add_control(whiteThemeButton, wui::rect{ 290, 350, 380, 375 });

    window->add_control(okButton, wui::rect{ 240, 450, 350, 480 });
    window->add_control(cancelButton, wui::rect{ 370, 450, 480, 480 });

    /*auto fileImageTheme = wui::make_custom_theme();
    fileImageTheme->set_string(wui::theme_value::images_path, L"d:\\");
    std::shared_ptr<wui::image> fileImage(new wui::image(L"g620.png", fileImageTheme));
    window->add_control(fileImage, wui::rect{ 180, 200, 344, 344 });*/

    window->set_min_size(100, 100);

    window->set_size_change_callback([&nameInput, &okButton, &cancelButton](int32_t w, int32_t h) {
        nameInput->set_position({ 10, 250, w - 10, 275 });
        okButton->set_position({ w - 250, h - 50, w - 150, h - 20});
        cancelButton->set_position({ w - 120, h - 50, w - 20, h - 20 });
    });

    window->init("Welcome to WUI!", wui::rect{ 100, 100, 600, 600 }, wui::window_style::frame, [&runned]() {
#ifdef _WIN32
        PostQuitMessage(IDCANCEL);
#elif __linux__
        runned = false;
#endif
    });
	
#ifdef _WIN32
    // Main message loop:
    MSG msg;
    while (GetMessage(&msg, nullptr, 0, 0))
    {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    //Gdiplus::GdiplusShutdown(gdiplusToken);
    return (int) msg.wParam;
#elif __linux__
    // Wait for main window
    while (runned)
    {
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }
    return 0;
#endif
}
